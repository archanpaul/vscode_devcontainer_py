# Python Development Container with Poetry

This repository provides a template for a Python development environment using VS Code Dev Containers. It's configured with Python 3.12, Poetry for dependency management, and a curated set of VS Code extensions and settings for a productive Python development experience.

## Features

-   **Containerized Environment**: Uses a Docker container to ensure a consistent and reproducible development setup.
-   **Python 3.12**: Based on the official `python:3.12-slim-bookworm` image for a lightweight and up-to-date environment.
-   **Dependency Management**:
    -   Uses Poetry for robust dependency management.
    -   Dependencies are organized into logical groups (`core`, `web`, `ml`, `dev`).
    -   The virtual environment is automatically created inside the project folder at `.venv/` for better project isolation.
-   **VS Code Integration**:
    -   Pre-configured `devcontainer.json` for a seamless experience.
    -   A curated list of essential extensions for Python, Jupyter, and AI-assisted development is installed automatically.
-   **Code Quality & Formatting**:
    -   **Black**: Integrated as the default code formatter, with format-on-save enabled.
    -   **isort**: Automatically sorts imports to keep them clean and organized.
    -   **Pylance**: Provides rich language support, including autocompletion and basic type checking.
-   **Jupyter Support**: Fully configured for developing and running Jupyter Notebooks directly within VS Code.
-   **Optimized Rebuilds**: A multi-stage `Dockerfile` is used to leverage local image caching, significantly speeding up container rebuilds.

## Getting Started

### Prerequisites

1.  **Docker Desktop**: Or another Docker-compatible runtime like Podman.
2.  **Visual Studio Code**: The code editor.
3.  **Dev Containers extension**: For VS Code (ID: `ms-vscode-remote.remote-containers`).

### Usage

1.  Clone this repository to your local machine.
2.  Open the repository folder in Visual Studio Code.
3.  When prompted, click on **"Reopen in Container"** to build and start the dev container. This might take a few minutes on the first run as it needs to download the Docker image and install dependencies.

Once the container is running, VS Code will be connected to the development environment, and you'll have access to a terminal within the container.

## Speeding Up Rebuilds with a Local Cache

The `Dockerfile` uses a multi-stage build to potentially speed up the process of rebuilding the dev container.

The build process is as follows:

1.  **Stage 1: Local Cache (`custom`)**
    ```dockerfile
    # Stage 1: use the pre_built image if it exists.
    # docker commit COMMIT_ID ml_devcontainer:latest
    FROM ml_devcontainer:latest as custom
    ```
    This first stage attempts to use a locally cached Docker image named `ml_devcontainer:latest`. This allows subsequent builds to start from a pre-built state, saving significant time.

2.  **Stage 2: Base Image**
    ```dockerfile
    # Stage 2: use a base Python 3.12 image
    FROM python:3.12-slim-bookworm
    ```
    If the `ml_devcontainer:latest` image is not found, the build gracefully falls back to using the official `python:3.12-slim-bookworm` image as its starting point. This ensures the container can always be built from scratch.

### How to Create the Local Cache

After you have built the container and are satisfied with its state (e.g., after installing system-level packages), you can create a local cache image:

1.  Find the `CONTAINER ID` of your running dev container.
2.  Commit the container to create a new image:
    ```bash
    docker commit <CONTAINER_ID> ml_devcontainer:latest
    ```
The next time you rebuild the container, Docker will use this cached image, speeding up the process.

## Dependency Management with Poetry

This project uses Poetry for dependency management.

By default, Poetry creates virtual environments in a central directory (e.g., `~/.cache/pypoetry/virtualenvs`). However, this project is configured via the `.devcontainer/devcontainer.json` file to create the virtual environment within the project directory at `.venv/`. This is achieved by setting the `POETRY_VIRTUALENVS_IN_PROJECT` environment variable to `true`, ensuring the environment is self-contained within the project.

### `pyproject.toml` and `poetry.lock`

-   **`pyproject.toml`**: This file defines your project's metadata, dependencies (including groups), and other Poetry configurations. It's where you declare what your project needs.
-   **`poetry.lock`**: This file is automatically generated and maintained by Poetry. It records the exact versions of all direct and transitive dependencies that were installed during the last `poetry install` or `poetry update` command. This ensures that everyone working on the project uses the exact same set of dependencies, leading to reproducible builds across different environments. You should commit `poetry.lock` to version control.

### Initial Setup

Upon building the container, Poetry installs the `core` and `dev` dependency groups.

### Dependency Groups

Dependencies are organized into groups in `pyproject.toml` for better management.
The available groups are:
-   `core`: The main dependencies required for the project to run (e.g., `requests`).
-   `web`: For web development (FastAPI, Flask, etc.).
-   `ml`: For machine learning (PyTorch, TensorFlow, Pandas, etc.).
-   `dev`: For development tools (Pytest, Black).

**To install additional groups (e.g., `web` and `ml`):**

```bash
poetry install --with web,ml
```

If you only want to install the core dependencies, run:

```bash
poetry install
```

### Adding a Dependency

To add a new dependency to the core group:

```bash
poetry add <package-name>
```

To add a new development dependency:

```bash
poetry add --group dev <package-name>
```

### Common Poetry Commands

-   **`poetry install`**: Installs the dependencies specified in `pyproject.toml` and `poetry.lock`. If `poetry.lock` does not exist, it will be created.
-   **`poetry update`**: Updates the dependencies to their latest compatible versions and updates `poetry.lock`.
-   **`poetry add <package>`**: Adds a new dependency to `pyproject.toml` and installs it.
-   **`poetry remove <package>`**: Removes a dependency from `pyproject.toml` and uninstalls it.
-   **`poetry run <command>`**: Executes a command within the project's virtual environment. For example, `poetry run pytest` to run tests.
-   **`poetry shell`**: Spawns a new shell within the project's virtual environment, allowing you to run commands directly without `poetry run`.

## VS Code Configuration

The `.devcontainer/devcontainer.json` file configures the VS Code editor inside the container. Key settings include:

-   **Default Python Interpreter**: Set to the Python version in the container.
-   **Formatter**: Black is set as the default formatter for Python files, and it will format on save.
-   **Extensions**: A list of recommended extensions for Python development, including Pylance, Jupyter, and Black Formatter, are automatically installed.

## How to save devcontainer image (podman)

- Find the container: `podman ps -a`
- Commit the container to an image: `podman commit <container_id_or_name> ml_devcontainer:latest`
- Verify the image: `podman images`
- Run a new container from the image: `podman run -it ml_devcontainer:latest /bin/bash`
- Save image for future use: `podman save -o ml_devcontainer_$(date +%Y%m%d).tar ml_devcontainer:latest`
- Reload container from saved image: `podman load -i ml_devcontainer_DATE.tar`

## Example uses-cases

- FastAPI with Uvicorn: `poetry run python -m uvicorn main:app --host 0.0.0.0 --port 8080 --reload
`

- Streamlit app: `poetry run streamlit run app.py --server.port 8080 --server.address 0.0.0.0
`

## License

This project is licensed under the terms of the GNU General Public License v3.0 (GPL-3.0).
